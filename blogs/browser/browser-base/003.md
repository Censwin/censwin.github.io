---
title: 003 HTTP协议
date: 2021-5-20
categories: 
 - 浏览器
tags:
 - 浏览器
sidebar: 'auto'
---
前面已经讲了`TCP` 那现在可以开始说一下`HTTP`了，本篇主要讲一下我们按下回车后整个`HTTP`请求流程是怎么样的。  
http: http是建立在TCP链接基础之上，这种协议允许浏览器向服务器获取资源；

## 发送请求阶段  



1. 【构建】首先浏览器会构建请求行信息，如：GET /index.html HTTP1.1 ；分别表示 【使用get方法】【请求什么资源】【http版本】；

2. 【查找缓存】此时浏览器先从浏览器中查询有没有已经过期的文件需要重新请求。（注：建立在第二次请求相同站点的基础上）；当发现浏览器中已存在副本会拦截请求返回资源副本；

3. 【域名解析】此时会将域名交给域名系统（DNS），由DNS解析后返回IP；**浏览器同时提供了DNS数据缓存服务**，如果某个域名已经解析过了，那么浏览器会缓存解析的结果，以供下次查询时直接使用，这样也会减少一次网络请求。

4. 【建立TCP连接】需要注意的是chrome只支持【相同域名】最多6个tcp链接，如果当下6个都被占满将会进入排队等待过程，少于6个则直接进入TCP连接阶段。连接过程参考上一篇。

5. 【发送HTTP】该阶段在3次握手后进行；

   1. 首先浏览器先向服务端发送第一步中构建好的【请求行】；
   2. 然后发送【请求头】，请求头包含很多基础信息，包括操作系统、keep-alive、浏览器版本等等；
   3. 最后如果发送的是POST请求的话还会发送一个【请求体】，比如form表单信息或二进制文件等
       <img :src="$withBase('/brower/httpreq.png')" />

## 接收请求阶段

1. 首先服务器会返回【响应行】，包括协议版本和状态码。

2. 随后，正如浏览器会随同请求发送请求头一样，服务器也会随同响应向浏览器发送【响应头】。响应头包含了服务器自身的一些信息，比如服务器生成返回数据的时间、返回的数据类型（JSON、HTML、流媒体等类型），以及服务器要在客户端保存的 Cookie 等信息。

3. 发送完响应头后，服务器就可以继续发送【响应体】的数据，通常，响应体就包含了 HTML 的实际内容。
  试试这段代码:
   ```shell
   curl -I geekbang.org
   ```
     <img :src="$withBase('/brower/httpres.png')" />

## 如何保持登录状态
  在响应头中可以看到set-cookie, 当浏览器开始解析响应头时，如果含有set-cookie,就会把这个字段信息保存到本地；当再次访问时会从cookie中取出值，并放到请求头中发送给服务端；

## 总结

HTTP 请求示意图：
    <img :src="$withBase('/brower/httppriod.png')" />  

## 问题

1. 如果一个页面的网络加载时间过久，你是如何分析卡在哪个阶段的？  
   1.  首先猜测最可能的出问题的地方，网络传输丢包比较严重，需要不断重传。然后通过ping、curl看看对应的时延高不高。  
     2. 然后通过wireshake看看具体哪里出了问题。
     3. 假如别人访问很快，自己电脑很慢，就要看看自己客户端是否有问题了。

2. 关闭浏览器时TCP连接由谁断开，当keep-alive时会一直保持连接状态吗？[相关文章](https://blog.csdn.net/cccallen/article/details/8003324)

