---
title: 002 web的生命周期
date: 2021-9-16
categories: 
 - 浏览器
tags:
 - 浏览器
sidebar: 'auto'
---

## URL

web 应用的生命周期往往从用户输入一串url按下回车或点击一个链接开始，那么当我们输入内容后一般会有两种情况：

1. 输入内容不符合url规则，那么此时浏览器进程会自动生成一个带关键字的url并自动跳转
2. 输入内容符合url规则，自动添加协议头并进行跳转

值得注意的是跳转前 浏览器会执行 `onbeforeunload` 可用于提示用户，具体用法如下

```jsx
// 用法1
<body onbeforeunload="return test()">
</body>
<script type="text/javascript">
    function test(){
        return "页面即将跳转";
    }
</script>
// 用法2
window.onbeforeunload=function(){
    return "页面即将跳转";
}
// 用法3 react
componentDidMount() {
  window.addEventListener("beforeunload", this.test);
}
componentWillUnmount() {
  window.removeEventListener("beforeunload", this.test);
}
```

## 网络请求

1. 查找缓存

   浏览器进程通过IPC将请求提交给网络进程，此时网络进程会开始查找强缓存，如果缓存在有效期内则直接返回。

2. DNS解析

   通过DNS解析url获得具体请求IP地址，值得注意的是DNS同样有缓存，存在缓存则直接返回，如果不指定端口则添加默认端口，http默认端口为80，https端口为443

3. 建立TCP连接

   通过三次握手建立TCP连接，注意：由于同源机制，chrome 只能建立不超过6个TCP连接（各家浏览器各不相同）。

   关于这一块的知识点另开一篇详细介绍

4. 建立TLS连接（使用 https 的情况下）

5. 发送http请求

   http请求包含 请求行[方法、URL、协议]、请求头 Cookie 等、请求体 （get请求除外），这里不再赘述。

6. 接收响应

   响应包含 响应行[协议、状态码、状态消息]、响应头、响应体等

   在众多 状态码 中我们需要特别注意的是 301(临时) / 302(永久) 这两个重定向状态码，当网络进程发现该状态码后，会在相应头中查找 `location` 字段，然后获取该字段的值直接进行跳转，此时尚未轮到 `渲染进程` 开始工作，所以从 `js` 的层面来说我们无法拦截301 / 302 状态，除了一种情况：响应头中没有`location`此时会直接进行下一步工作。

7. 完成了网络请求和响应，如果响应头中`Content-Type`的值是`text/html`，那么接下来就是浏览器的`解析`和`渲染`工作了

## 解析

1. 构建DOM树

   由于浏览器无法理解HTML字符串，因此会将其转换为有意义且便于操作的数据结构，这种数据结构就是`DOM树`,在控制台输入`document`即可查看构建后的`DOM树`

2. 样式计算

   由于浏览器同样无法识别CSS样式文本，所以同样会将其转换为一种结构化对象，这个结构化对象就是 `styleSheet`在控制台输入`styleSheet` 即可看到结构化后的CSS

